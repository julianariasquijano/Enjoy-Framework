<?php

//TODO create app repository

function creataDataRepFile($fileName,$app) {
    
    $content='<?php

require_once "lib/dataRepositories/interfaces.php";

class '.$app.'DataRep implements dataRep_Interface {

    var $instance=null;
    var $host;
    var $dbname;
    var $username;
    var $password;    
    
    function __construct() {
        
        $this->host	= "localhost";
        $this->dbname 	= "'.$app.'";
        $this->username = "";
        $this->password = "";        
        
    }

    function getInstance() {

        $this->instance = new PDO("mysql:host=" . $this->host . ";dbname=" . $this->dbname, $this->username, $this->password);
        $this->instance->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        return $this->instance;
        
    }
    
    function close() {
        $this->instance = null;
    }

    public function dbExists($dataBase=null) {
        
        if ($dataBase == null) $dataBase=$this->dbname;
        
        $sql="SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME=\'$dataBase\'";
        $query = $this->dataRep->prepare($sql);
        $query->execute();
        $results = $query->fetchAll(PDO::FETCH_ASSOC);
        
        if (count($results)) {
            return true;
        }
        else return false;
        
    }

    public function __destruct() {
        $this->close();
    }

}';
    createFile($fileName,$content);
    
}
function createModel($fileName,$app,$module) {
    
    $content='<?php

//Model Class

require_once "lib/enjoyClassBase/modelBase.php";
require_once "applications/'.$app.'/modules/'.$module.'/models/table_'.$module.'.php";

//require_once "applications/'.$app.'/modules/---/models/model_---.php";


class '.$module.'Model extends modelBase {

    var $tables="'.$module.'";

    function __construct($dataRep, $config) {
        parent::__construct($dataRep, $config);
        $table=new table_'.$module.'();
        $this->fieldsConfig=$table->fieldsConfig;
        $this->primaryKey=$table->primaryKey;
        
        //$---Model=new ---Model($dataRep,$config);
                
        $this->label=array(
            "es_es"=>"You Should set the label of the Module.",
        );
        
//        $this->foreignKeys = array (
//            "---_id" => array(
//                "model"=>&$---Model,
//                "keyField"=>"theOthertableName.idPossibly",
//                "dataField"=>"another Field of the foreign table with data",
//             ),
//        );

//        $this->subModels=array( //For many to many relations for example
//            0=>array(
//                "model"=>&$---Model ,
//                "linkerField"=>$this->primaryKey,
//                "linkedField"=>"external field that references this primary key",
//                "linkedDataField"=>"similar as a foreignKey dataField",
//                "type"=>"multiple",
//            ),
//        );

//        $this->dependents=array(
//            "id"=>array(
//                0=>array(
//                  "mod"=>"someModule",
//                    "act"=>"index",
//                    "keyField"=>"field of the dependent table that references here",
//                    "label"=>array(
//                        "es_es" =>"DependentCaption",
//                    ),
//                ),              
//            ),
//        );

    }
    
}';
    
    createFile($fileName,$content);
}
function createModelTable($fileName,$module) {
    
    $content='<?php

class table_'.$module.' {

    var $primaryKey = "id";
    var $fieldsConfig;

    function __construct() {

        $this->fieldsConfig = array(
            "id" => array(
                "definition" => array(
                    "type" => "number",
                    //"options"=>array("required"),
                    "default" => "",
                    "label" => array(
                        "es_es" => "Serial",
                    ),
                    //"widget" => "textarea",
                ),
            ),
        );
    }        
}   ';

    createFile($fileName,$content);
}
function createView($fileName) {
    
    $content='<span style="font-size: xx-large;">&nbsp;&nbsp;<?php  echo $label  ?></span>
<br/>
<?php echo $crud  ?>';
    
    createFile($fileName,$content);
}
function createController($fileName) {
    
    $content='<?php
        
//Module Controller Class
require_once "lib/enjoyClassBase/controllerBase.php";

class modController extends controllerBase {

    function indexAction() {
        $this->crudAction($this->baseModel,$this->dataRep);
    }

}';
    createFile($fileName,$content);

}


function createFile($fileName,$content) {
    $handle = fopen($fileName, "a+");
    fwrite($handle, $content);
    fclose($handle);
}


require_once "../applications/appServerConfig.php"; //Expose variable $appServerConfig

if ($appServerConfig['base']['platform']=='windows')
    $ds="\\"; // Directory Separator
else
    $ds="/";



/*
 * Start
 */

if (count($argv) < 3) {
    exit ("\r\ncrud_start.enj Builds the crud structure.\r\nEj:php crud_start.enj \"appName\" \"module1,module2,etc\")\r\nRemember to have correspondence between the names of the modules and the DB tables.\r\n\r\n");
}

$app=$argv[1];
$modules=$argv[2];
$modulesArray=explode(',', $modules);

$dataRepDir='..'.$ds."applications".$ds.$app.$ds."dataRep";
$dataRepFile=$dataRepDir.$ds."app_dataRep.php";

if (!file_exists($dataRepDir)) {
    mkdir($dataRepDir, '0770', TRUE);
}
if (!file_exists($dataRepFile)) {
    creataDataRepFile($dataRepFile,$app);
}

foreach ($modulesArray as $module) {
    $modulePath='..'.$ds."applications".$ds.$app.$ds."modules".$ds.$module;
    $modelsPath=$modulePath.$ds."models";
    $viewsPath=$modulePath.$ds."views";
    
    if (!file_exists($modulePath)) {
        mkdir($modulePath, '0770', TRUE);
    }
    if (!file_exists($modelsPath)) {
        mkdir($modelsPath, '0770', TRUE);
    }
    if (!file_exists($viewsPath)) {
        mkdir($viewsPath, '0770', TRUE);
    }
    
    $modelFileName=$modelsPath.$ds."model_$module.php";
    $modelTableFileName=$modelsPath.$ds."table_$module.php";
    $viewFileName=$viewsPath.$ds."view_index.php";
    $controllerFileName=$modulePath.$ds."controller_$module.php";
    
    if (!file_exists($modelFileName)) {
        createModel($modelFileName,$app,$module);
    }
    if (!file_exists($modelTableFileName)) {
        createModelTable($modelTableFileName,$module);
    }
    if (!file_exists($viewFileName)) {
        createView($viewFileName);
    }
    if (!file_exists($controllerFileName)) {
        createController($controllerFileName);
    }
    
    
}
